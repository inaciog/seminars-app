name: Daily Backup

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Start machine and run backup
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Finding the app machine..."
          # Get the machine ID for the seminars-app (not the alpine one)
          MACHINE_ID=$(flyctl machine list --app seminars-app --json | jq -r '.[] | select(.image | contains("seminars-app")) | .id')
          echo "Machine ID: $MACHINE_ID"
          
          if [ -z "$MACHINE_ID" ]; then
            echo "ERROR: Could not find app machine"
            exit 1
          fi
          
          echo "Starting the machine..."
          flyctl machine start "$MACHINE_ID" --app seminars-app || true
          
          # Wait for machine to be ready for SSH (try up to 90 seconds)
          echo "Waiting for machine to be ready for SSH..."
          for i in {1..18}; do
            if flyctl ssh console --app seminars-app -C "echo ready" 2>/dev/null | grep -q ready; then
              echo "Machine is ready!"
              break
            fi
            echo "Waiting... ($i/18)"
            sleep 5
          done
          
          echo "Running backup..."
          flyctl ssh console --app seminars-app -C "/app/backup.sh" || {
            echo "Backup failed"
            exit 1
          }
          echo "Backup completed"

      - name: Check Backup Status
        if: success()
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl ssh console --app seminars-app -C "ls -lh /data/backups/*.tar.gz | tail -5"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Backup failed! Check Fly.io logs: fly logs --app seminars-app"
