name: Daily Backup

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Wake up app and run backup
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Waking up the app..."
          # Make a request to wake up the machine (auto-start on Fly.io)
          curl -s --max-time 30 https://seminars-app.fly.dev/api/health || true
          echo ""
          
          # Wait for machine to be ready for SSH (try up to 60 seconds)
          echo "Waiting for machine to be ready for SSH..."
          for i in {1..12}; do
            if flyctl ssh console --app seminars-app -C "echo ready" 2>/dev/null | grep -q ready; then
              echo "Machine is ready!"
              break
            fi
            echo "Waiting... ($i/12)"
            sleep 5
          done
          
          echo "Running backup..."
          flyctl ssh console --app seminars-app -C "/app/backup.sh" || {
            echo "Backup failed"
            exit 1
          }
          echo "Backup completed"

      - name: Check Backup Status
        if: success()
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl ssh console --app seminars-app -C "ls -lh /data/backups/*.tar.gz | tail -5"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Backup failed! Check Fly.io logs: fly logs --app seminars-app"
