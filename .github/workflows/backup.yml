name: Daily Backup

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Wake up app
        run: |
          echo "Waking up the app (this starts the machine if stopped)..."
          # Make a request to wake up the machine
          curl -s --max-time 30 https://seminars-app.fly.dev/api/health || true
          echo ""
          # Wait for machine to fully start
          sleep 15

      - name: Run backup
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Running backup on Fly.io..."
          flyctl ssh console --app seminars-app -C "/app/backup.sh" || {
            echo "Backup failed"
            exit 1
          }
          echo "Backup completed"

      - name: Check Backup Status
        if: success()
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          # List recent backups
          flyctl ssh console --app seminars-app -C "ls -lh /data/backups/*.tar.gz | tail -5"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Backup failed! Check Fly.io logs: fly logs --app seminars-app"
